<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Estimating MCC After Matching or Weighting • mccount</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Estimating MCC After Matching or Weighting">
<meta name="description" content="Learn how to estimate mean cumulative count after propensity score matching  or inverse probability weighting for causal inference.
">
<meta property="og:description" content="Learn how to estimate mean cumulative count after propensity score matching  or inverse probability weighting for causal inference.
">
<meta property="og:image" content="https://kennethataylor.github.io/mccount/logo.svg">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">mccount</a>

    <small class="nav-text text-danger me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Unreleased version">0.0.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/mccount.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/choosing-between-methods.html">Choosing Between Methods</a></li>
    <li><a class="dropdown-item" href="../articles/estimating-mcc-after-matching-or-weighting.html">Estimating MCC After Matching or Weighting</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/KennethATaylor/mccount/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Estimating MCC After Matching or Weighting</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/KennethATaylor/mccount/blob/HEAD/vignettes/estimating-mcc-after-matching-or-weighting.Rmd" class="external-link"><code>vignettes/estimating-mcc-after-matching-or-weighting.Rmd</code></a></small>
      <div class="d-none name"><code>estimating-mcc-after-matching-or-weighting.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Treatment assignment is not randomized in observational studies of
recurrent events, which can lead to confounding bias when estimating
causal effects. The mean cumulative count (MCC) can be estimated after
applying propensity score methods to address confounding, following the
approach described by Gaber, <em>et al</em>.<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Gaber CE, Edwards JK, Lund JL, Peery AF, Richardson DB,
Kinlaw AC. Inverse Probability Weighting to Estimate Exposure Effects on
the Burden of Recurrent Outcomes in the Presence of Competing Events.
&lt;em&gt;Am J Epidemiol&lt;/em&gt;. 2023;192(5):830-839. doi: &lt;a href="https://doi.org/10.1093/aje/kwad031" class="external-link"&gt;10.1093/aje/kwad031&lt;/a&gt;&lt;/p&gt;'><sup>1</sup></a></p>
<p>This vignette demonstrates how to:</p>
<ul>
<li>Use inverse probability of treatment weighting (IPTW) with MCC
estimation</li>
<li>Apply MCC estimation after various propensity score matching
methods</li>
<li>Interpret weighted and matched results appropriately</li>
</ul>
</div>
<div class="section level2">
<h2 id="when-to-use-weights-with-mcc">When to Use Weights with MCC<a class="anchor" aria-label="anchor" href="#when-to-use-weights-with-mcc"></a>
</h2>
<p>The standard (unweighted) Dong-Yasui estimator provides unbiased
estimates of the MCC in randomized trials or when there is no
confounding bias. However, in observational studies, we need to account
for measured confounders that affect both treatment assignment and the
recurrent outcome.</p>
<p><strong>Key principle</strong>: Use weights when you want to estimate
the causal effect of treatment on recurrent event burden, not just
describe the observed association.</p>
</div>
<div class="section level2">
<h2 id="inverse-probability-of-treatment-weighting-iptw">Inverse Probability of Treatment Weighting (IPTW)<a class="anchor" aria-label="anchor" href="#inverse-probability-of-treatment-weighting-iptw"></a>
</h2>
<div class="section level3">
<h3 id="step-1-estimate-propensity-scores-and-create-weights">Step 1: Estimate Propensity Scores and Create Weights<a class="anchor" aria-label="anchor" href="#step-1-estimate-propensity-scores-and-create-weights"></a>
</h3>
<p>We’ll use the <code><a href="https://rdrr.io/pkg/survival/man/bladder.html" class="external-link">survival::bladder1</a></code> dataset and create a
binary treatment variable for demonstration:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/KennethATaylor/mccount" class="external-link">mccount</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ngreifer.github.io/WeightIt/" class="external-link">WeightIt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://kosukeimai.github.io/MatchIt/" class="external-link">MatchIt</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://patchwork.data-imaginist.com" class="external-link">patchwork</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create example data with binary treatment</span></span>
<span><span class="va">bladder_nested</span> <span class="op">&lt;-</span> <span class="fu">survival</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/survival/man/bladder.html" class="external-link">bladder1</a></span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>status <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">status</span> <span class="op">&gt;</span> <span class="fl">2</span>, <span class="fl">2</span>, <span class="va">status</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"placebo"</span>, <span class="st">"thiotepa"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/nest.html" class="external-link">nest</a></span><span class="op">(</span>.by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">id</span>, <span class="va">treatment</span>, <span class="va">number</span>, <span class="va">size</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>treatment_binary <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html" class="external-link">if_else</a></span><span class="op">(</span><span class="va">treatment</span> <span class="op">==</span> <span class="st">"thiotepa"</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate propensity scores and create IPTW weights using WeightIt</span></span>
<span><span class="va">weight_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ngreifer.github.io/WeightIt/reference/weightit.html" class="external-link">weightit</a></span><span class="op">(</span></span>
<span>  <span class="va">treatment_binary</span> <span class="op">~</span> <span class="va">number</span> <span class="op">+</span> <span class="va">size</span>, </span>
<span>  data <span class="op">=</span> <span class="va">bladder_nested</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Extract weights</span></span>
<span><span class="va">bladder_nested</span><span class="op">$</span><span class="va">iptw_weights</span> <span class="op">&lt;-</span> <span class="va">weight_obj</span><span class="op">$</span><span class="va">weights</span></span>
<span></span>
<span><span class="va">bladder_example</span> <span class="op">&lt;-</span> <span class="va">bladder_nested</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-2-estimate-weighted-mcc">Step 2: Estimate Weighted MCC<a class="anchor" aria-label="anchor" href="#step-2-estimate-weighted-mcc"></a>
</h3>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate MCC with IPTW weights</span></span>
<span><span class="va">mcc_weighted</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcc.html">mcc</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">bladder_example</span>,</span>
<span>  id_var <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  time_var <span class="op">=</span> <span class="st">"stop"</span>,</span>
<span>  cause_var <span class="op">=</span> <span class="st">"status"</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"treatment"</span>,</span>
<span>  weights <span class="op">=</span> <span class="st">"iptw_weights"</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"equation"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Found 7 participants where last observation is an event of interest</span></span>
<span><span class="co">#&gt; (`cause_var` = 1)</span></span>
<span><span class="co">#&gt; First 5 IDs: 13, 15, 16, 19, 24</span></span>
<span><span class="co">#&gt; Total affected: 7 participants</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> `mcc()` assumes these participants are censored at their final `time_var`</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> If participants were actually censored or experienced competing risks after</span></span>
<span><span class="co">#&gt;   their last event, add those observations to ensure correct estimates</span></span>
<span><span class="co">#&gt; Warning: Found 2 participants where last observation is an event of interest</span></span>
<span><span class="co">#&gt; (`cause_var` = 1)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> ID: 83, 104</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> `mcc()` assumes these participants are censored at their final `time_var`</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> If participants were actually censored or experienced competing risks after</span></span>
<span><span class="co">#&gt;   their last event, add those observations to ensure correct estimates</span></span>
<span></span>
<span><span class="co"># Display results</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mcc_weighted</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Summary of Mean Cumulative Count Results</span> <span style="color: #00BBBB;">────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Method: <span style="color: #0000BB;">Dong-Yasui Equation Method</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Weighted estimation: <span style="color: #0000BB;">Yes</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Total participants: <span style="color: #0000BB;">86</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Overall observation period: [<span style="color: #0000BB;">0</span>, <span style="color: #0000BB;">64</span>]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Summary by Group (</span><span style="color: #0000BB; font-weight: bold;">treatment</span><span style="font-weight: bold;">)</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Group: <span style="color: #0000BB;">placebo</span></span></span>
<span><span class="co">#&gt; Participants in group: <span style="color: #0000BB;">48</span></span></span>
<span><span class="co">#&gt; Group observation period: [<span style="color: #0000BB;">0</span>, <span style="color: #0000BB;">64</span>]</span></span>
<span><span class="co">#&gt; Time to MCC = 1.0: <span style="color: #0000BB;">17</span></span></span>
<span><span class="co">#&gt; Time to maximum MCC: <span style="color: #0000BB;">53</span></span></span>
<span><span class="co">#&gt; MCC at end of follow-up: <span style="color: #0000BB;">2.6759</span></span></span>
<span><span class="co">#&gt; Events of interest: <span style="color: #0000BB;">87</span></span></span>
<span><span class="co">#&gt; Competing risk events: <span style="color: #0000BB;">11</span></span></span>
<span><span class="co">#&gt; Censoring events: <span style="color: #0000BB;">30</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Group: <span style="color: #0000BB;">thiotepa</span></span></span>
<span><span class="co">#&gt; Participants in group: <span style="color: #0000BB;">38</span></span></span>
<span><span class="co">#&gt; Group observation period: [<span style="color: #0000BB;">0</span>, <span style="color: #0000BB;">59</span>]</span></span>
<span><span class="co">#&gt; Time to MCC = 1.0: <span style="color: #0000BB;">29</span></span></span>
<span><span class="co">#&gt; Time to maximum MCC: <span style="color: #0000BB;">47</span></span></span>
<span><span class="co">#&gt; MCC at end of follow-up: <span style="color: #0000BB;">1.4006</span></span></span>
<span><span class="co">#&gt; Events of interest: <span style="color: #0000BB;">45</span></span></span>
<span><span class="co">#&gt; Competing risk events: <span style="color: #0000BB;">11</span></span></span>
<span><span class="co">#&gt; Censoring events: <span style="color: #0000BB;">25</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="step-3-compare-weighted-vs-unweighted-results">Step 3: Compare Weighted vs Unweighted Results<a class="anchor" aria-label="anchor" href="#step-3-compare-weighted-vs-unweighted-results"></a>
</h3>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate unweighted MCC for comparison</span></span>
<span><span class="va">mcc_unweighted</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcc.html">mcc</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">bladder_example</span>,</span>
<span>  id_var <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  time_var <span class="op">=</span> <span class="st">"stop"</span>,</span>
<span>  cause_var <span class="op">=</span> <span class="st">"status"</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"treatment"</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"equation"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Found 7 participants where last observation is an event of interest</span></span>
<span><span class="co">#&gt; (`cause_var` = 1)</span></span>
<span><span class="co">#&gt; First 5 IDs: 13, 15, 16, 19, 24</span></span>
<span><span class="co">#&gt; Total affected: 7 participants</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> `mcc()` assumes these participants are censored at their final `time_var`</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> If participants were actually censored or experienced competing risks after</span></span>
<span><span class="co">#&gt;   their last event, add those observations to ensure correct estimates</span></span>
<span><span class="co">#&gt; Warning: Found 2 participants where last observation is an event of interest</span></span>
<span><span class="co">#&gt; (`cause_var` = 1)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> ID: 83, 104</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> `mcc()` assumes these participants are censored at their final `time_var`</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> If participants were actually censored or experienced competing risks after</span></span>
<span><span class="co">#&gt;   their last event, add those observations to ensure correct estimates</span></span>
<span></span>
<span><span class="co"># Extract final MCC values for comparison</span></span>
<span><span class="va">weighted_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcc_final_values.html">mcc_final_values</a></span><span class="op">(</span><span class="va">mcc_weighted</span><span class="op">)</span></span>
<span><span class="va">unweighted_final</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcc_final_values.html">mcc_final_values</a></span><span class="op">(</span><span class="va">mcc_unweighted</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Create comparison table</span></span>
<span><span class="va">comparison_table</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  Method <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Unweighted"</span>, <span class="st">"IPTW Weighted"</span><span class="op">)</span>,</span>
<span>  Control_MCC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu">cards</span><span class="fu">::</span><span class="fu"><a href="https://insightsengineering.github.io/cards/latest-tag/reference/round5.html" class="external-link">round5</a></span><span class="op">(</span><span class="va">unweighted_final</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="fu">cards</span><span class="fu">::</span><span class="fu"><a href="https://insightsengineering.github.io/cards/latest-tag/reference/round5.html" class="external-link">round5</a></span><span class="op">(</span><span class="va">weighted_final</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  Treated_MCC <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="fu">cards</span><span class="fu">::</span><span class="fu"><a href="https://insightsengineering.github.io/cards/latest-tag/reference/round5.html" class="external-link">round5</a></span><span class="op">(</span><span class="va">unweighted_final</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>,</span>
<span>    <span class="fu">cards</span><span class="fu">::</span><span class="fu"><a href="https://insightsengineering.github.io/cards/latest-tag/reference/round5.html" class="external-link">round5</a></span><span class="op">(</span><span class="va">weighted_final</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, digits <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">knitr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/knitr/man/kable.html" class="external-link">kable</a></span><span class="op">(</span><span class="va">comparison_table</span><span class="op">)</span></span></code></pre></div>
<table class="table">
<thead><tr class="header">
<th align="left">Method</th>
<th align="right">Control_MCC</th>
<th align="right">Treated_MCC</th>
</tr></thead>
<tbody>
<tr class="odd">
<td align="left">Unweighted</td>
<td align="right">2.61</td>
<td align="right">1.55</td>
</tr>
<tr class="even">
<td align="left">IPTW Weighted</td>
<td align="right">2.68</td>
<td align="right">1.40</td>
</tr>
</tbody>
</table>
<p>The weighted estimates represent the causal effect of treatment on
recurrent event burden, adjusted for measured confounding.</p>
</div>
</div>
<div class="section level2">
<h2 id="propensity-score-matching">Propensity Score Matching<a class="anchor" aria-label="anchor" href="#propensity-score-matching"></a>
</h2>
<div class="section level3">
<h3 id="important-note-on-matching-weights">Important Note on Matching Weights<a class="anchor" aria-label="anchor" href="#important-note-on-matching-weights"></a>
</h3>
<p>For propensity score matching:</p>
<ul>
<li>
<strong>Simple 1:1 nearest neighbor matching without
replacement</strong>: No additional weighting is necessary when using
the matched dataset (because the matching weights for all untrimmed
treated and control units equal 1)</li>
<li>
<strong>Complex matching methods</strong> (e.g., optimal matching,
full matching, subclassification): Use the matching weights provided by
the matching procedure in the same way as IPTW weights</li>
</ul>
</div>
<div class="section level3">
<h3 id="example-11-nearest-neighbor-matching-no-weights-needed">Example: 1:1 Nearest Neighbor Matching (No Weights Needed)<a class="anchor" aria-label="anchor" href="#example-11-nearest-neighbor-matching-no-weights-needed"></a>
</h3>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform 1:1 nearest neighbor matching</span></span>
<span><span class="va">match_nn</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html" class="external-link">matchit</a></span><span class="op">(</span></span>
<span>  <span class="va">treatment_binary</span> <span class="op">~</span> <span class="va">size</span> <span class="op">+</span> <span class="va">number</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bladder_nested</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If you run <code>match_nn</code> in the console, you’ll see that only
76 out of the original 86 patients were matched using the nearest
neighbor approach, which can change the estimand we can estimate with
nearest neighbor matching from the average treatment effect among the
treated (ATT) to the average treatment among the remaining matched
sample (ATM). See <a href="https://kosukeimai.github.io/MatchIt/" class="external-link">MatchIt</a> for more details regarding
matching methods and causal estimands.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Extract matched data (no additional weights needed)</span></span>
<span><span class="va">matched_nn_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match_data.html" class="external-link">match.data</a></span><span class="op">(</span><span class="va">match_nn</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Estimate MCC on matched data without additional weights</span></span>
<span><span class="va">mcc_nn_matched</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcc.html">mcc</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">matched_nn_data</span>,</span>
<span>  id_var <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  time_var <span class="op">=</span> <span class="st">"stop"</span>, </span>
<span>  cause_var <span class="op">=</span> <span class="st">"status"</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"treatment_binary"</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"equation"</span></span>
<span>  <span class="co"># No weights argument needed for simple 1:1 matching (all weights are 1)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Converting numeric grouping variable <span style="color: #0000BB;">"by_var"</span> to <span style="color: #0000BB;">&lt;factor&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Found 2 unique groups: <span style="color: #0000BB;">0</span> and <span style="color: #0000BB;">1</span></span></span>
<span><span class="co">#&gt; Warning: Found 5 participants where last observation is an event of interest</span></span>
<span><span class="co">#&gt; (`cause_var` = 1)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> ID: 13, 16, 19, 34, 44</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> `mcc()` assumes these participants are censored at their final `time_var`</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> If participants were actually censored or experienced competing risks after</span></span>
<span><span class="co">#&gt;   their last event, add those observations to ensure correct estimates</span></span>
<span><span class="co">#&gt; Warning: Found 2 participants where last observation is an event of interest</span></span>
<span><span class="co">#&gt; (`cause_var` = 1)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> ID: 83, 104</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> `mcc()` assumes these participants are censored at their final `time_var`</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> If participants were actually censored or experienced competing risks after</span></span>
<span><span class="co">#&gt;   their last event, add those observations to ensure correct estimates</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mcc_nn_matched</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Summary of Mean Cumulative Count Results</span> <span style="color: #00BBBB;">────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Method: <span style="color: #0000BB;">Dong-Yasui Equation Method</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Total participants: <span style="color: #0000BB;">76</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Overall observation period: [<span style="color: #0000BB;">0</span>, <span style="color: #0000BB;">64</span>]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Summary by Group (</span><span style="color: #0000BB; font-weight: bold;">treatment_binary</span><span style="font-weight: bold;">)</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Group: <span style="color: #0000BB;">0</span> </span></span>
<span><span class="co">#&gt; Participants in group: <span style="color: #0000BB;">38</span></span></span>
<span><span class="co">#&gt; Group observation period: [<span style="color: #0000BB;">0</span>, <span style="color: #0000BB;">64</span>]</span></span>
<span><span class="co">#&gt; Time to MCC = 1.0: <span style="color: #0000BB;">22</span></span></span>
<span><span class="co">#&gt; Time to maximum MCC: <span style="color: #0000BB;">53</span></span></span>
<span><span class="co">#&gt; MCC at end of follow-up: <span style="color: #0000BB;">2.5943</span></span></span>
<span><span class="co">#&gt; Events of interest: <span style="color: #0000BB;">63</span></span></span>
<span><span class="co">#&gt; Competing risk events: <span style="color: #0000BB;">7</span></span></span>
<span><span class="co">#&gt; Censoring events: <span style="color: #0000BB;">26</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Group: <span style="color: #0000BB;">1</span> </span></span>
<span><span class="co">#&gt; Participants in group: <span style="color: #0000BB;">38</span></span></span>
<span><span class="co">#&gt; Group observation period: [<span style="color: #0000BB;">0</span>, <span style="color: #0000BB;">59</span>]</span></span>
<span><span class="co">#&gt; Time to MCC = 1.0: <span style="color: #0000BB;">27</span></span></span>
<span><span class="co">#&gt; Time to maximum MCC: <span style="color: #0000BB;">47</span></span></span>
<span><span class="co">#&gt; MCC at end of follow-up: <span style="color: #0000BB;">1.5463</span></span></span>
<span><span class="co">#&gt; Events of interest: <span style="color: #0000BB;">45</span></span></span>
<span><span class="co">#&gt; Competing risk events: <span style="color: #0000BB;">11</span></span></span>
<span><span class="co">#&gt; Censoring events: <span style="color: #0000BB;">25</span></span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="example-full-matching-with-weights">Example: Full Matching with Weights<a class="anchor" aria-label="anchor" href="#example-full-matching-with-weights"></a>
</h3>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Perform full matching (creates matching weights)</span></span>
<span><span class="va">match_obj</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/matchit.html" class="external-link">matchit</a></span><span class="op">(</span></span>
<span>  <span class="va">treatment_binary</span> <span class="op">~</span> <span class="va">size</span> <span class="op">+</span> <span class="va">number</span>,</span>
<span>  data <span class="op">=</span> <span class="va">bladder_nested</span>,</span>
<span>  method <span class="op">=</span> <span class="st">"full"</span>,      <span class="co"># Full matching creates weights</span></span>
<span>  estimand <span class="op">=</span> <span class="st">"ATE"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check matching balance</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">match_obj</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt; matchit(formula = treatment_binary ~ size + number, data = bladder_nested, </span></span>
<span><span class="co">#&gt;     method = "full", estimand = "ATE")</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for All Data:</span></span>
<span><span class="co">#&gt;          Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance        0.4495        0.4358          0.2312     1.6411    0.0477</span></span>
<span><span class="co">#&gt; size            1.9211        2.0625         -0.0986     0.7794    0.0230</span></span>
<span><span class="co">#&gt; number          2.3158        1.9167          0.2232     2.0164    0.0587</span></span>
<span><span class="co">#&gt;          eCDF Max</span></span>
<span><span class="co">#&gt; distance   0.1217</span></span>
<span><span class="co">#&gt; size       0.0636</span></span>
<span><span class="co">#&gt; number     0.1217</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Summary of Balance for Matched Data:</span></span>
<span><span class="co">#&gt;          Means Treated Means Control Std. Mean Diff. Var. Ratio eCDF Mean</span></span>
<span><span class="co">#&gt; distance        0.4422        0.4414          0.0141     1.0362    0.0094</span></span>
<span><span class="co">#&gt; size            1.9884        1.9767          0.0081     0.8714    0.0150</span></span>
<span><span class="co">#&gt; number          2.1008        2.0698          0.0173     1.1531    0.0177</span></span>
<span><span class="co">#&gt;          eCDF Max Std. Pair Dist.</span></span>
<span><span class="co">#&gt; distance   0.0465           0.046</span></span>
<span><span class="co">#&gt; size       0.0310           0.268</span></span>
<span><span class="co">#&gt; number     0.0465           0.086</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Sample Sizes:</span></span>
<span><span class="co">#&gt;               Control Treated</span></span>
<span><span class="co">#&gt; All             48.     38.  </span></span>
<span><span class="co">#&gt; Matched (ESS)   44.04   31.83</span></span>
<span><span class="co">#&gt; Matched         48.     38.  </span></span>
<span><span class="co">#&gt; Unmatched        0.      0.  </span></span>
<span><span class="co">#&gt; Discarded        0.      0.</span></span>
<span></span>
<span><span class="co"># Extract matched data with weights</span></span>
<span><span class="va">matched_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://kosukeimai.github.io/MatchIt/reference/match_data.html" class="external-link">match_data</a></span><span class="op">(</span><span class="va">match_obj</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>  <span class="fu">tidyr</span><span class="fu">::</span><span class="fu"><a href="https://tidyr.tidyverse.org/reference/unnest.html" class="external-link">unnest</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># The 'weights' column contains the matching weights</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">matched_data</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"id"</span>, <span class="st">"treatment"</span>, <span class="st">"weights"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 3</span></span></span>
<span><span class="co">#&gt;      id treatment weights</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;int&gt;</span> <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span>     1 placebo      1.67</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span>     2 placebo      1.12</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span>     3 placebo      1.12</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span>     4 placebo      1.12</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span>     5 placebo      2.23</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span>     6 placebo      1.12</span></span></code></pre></div>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Estimate MCC using matching weights</span></span>
<span><span class="va">mcc_matched</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/mcc.html">mcc</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="va">matched_data</span>,</span>
<span>  id_var <span class="op">=</span> <span class="st">"id"</span>,</span>
<span>  time_var <span class="op">=</span> <span class="st">"stop"</span>,</span>
<span>  cause_var <span class="op">=</span> <span class="st">"status"</span>,</span>
<span>  by <span class="op">=</span> <span class="st">"treatment"</span>,</span>
<span>  weights <span class="op">=</span> <span class="st">"weights"</span>,  <span class="co"># Use matching weights from MatchIt</span></span>
<span>  method <span class="op">=</span> <span class="st">"equation"</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Found 7 participants where last observation is an event of interest</span></span>
<span><span class="co">#&gt; (`cause_var` = 1)</span></span>
<span><span class="co">#&gt; First 5 IDs: 13, 15, 16, 19, 24</span></span>
<span><span class="co">#&gt; Total affected: 7 participants</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> `mcc()` assumes these participants are censored at their final `time_var`</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> If participants were actually censored or experienced competing risks after</span></span>
<span><span class="co">#&gt;   their last event, add those observations to ensure correct estimates</span></span>
<span><span class="co">#&gt; Warning: Found 2 participants where last observation is an event of interest</span></span>
<span><span class="co">#&gt; (`cause_var` = 1)</span></span>
<span><span class="co">#&gt; <span style="color: #BBBB00;">!</span> ID: 83, 104</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> `mcc()` assumes these participants are censored at their final `time_var`</span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> If participants were actually censored or experienced competing risks after</span></span>
<span><span class="co">#&gt;   their last event, add those observations to ensure correct estimates</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mcc_matched</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">──</span> <span style="font-weight: bold;">Summary of Mean Cumulative Count Results</span> <span style="color: #00BBBB;">────────────────────────────────────</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Method: <span style="color: #0000BB;">Dong-Yasui Equation Method</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Weighted estimation: <span style="color: #0000BB;">Yes</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Total participants: <span style="color: #0000BB;">86</span></span></span>
<span><span class="co">#&gt; <span style="color: #00BBBB;">ℹ</span> Overall observation period: [<span style="color: #0000BB;">0</span>, <span style="color: #0000BB;">64</span>]</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── <span style="font-weight: bold;">Summary by Group (</span><span style="color: #0000BB; font-weight: bold;">treatment</span><span style="font-weight: bold;">)</span> ──</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Group: <span style="color: #0000BB;">placebo</span></span></span>
<span><span class="co">#&gt; Participants in group: <span style="color: #0000BB;">48</span></span></span>
<span><span class="co">#&gt; Group observation period: [<span style="color: #0000BB;">0</span>, <span style="color: #0000BB;">64</span>]</span></span>
<span><span class="co">#&gt; Time to MCC = 1.0: <span style="color: #0000BB;">17</span></span></span>
<span><span class="co">#&gt; Time to maximum MCC: <span style="color: #0000BB;">53</span></span></span>
<span><span class="co">#&gt; MCC at end of follow-up: <span style="color: #0000BB;">2.5748</span></span></span>
<span><span class="co">#&gt; Events of interest: <span style="color: #0000BB;">87</span></span></span>
<span><span class="co">#&gt; Competing risk events: <span style="color: #0000BB;">11</span></span></span>
<span><span class="co">#&gt; Censoring events: <span style="color: #0000BB;">30</span></span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; ── Group: <span style="color: #0000BB;">thiotepa</span></span></span>
<span><span class="co">#&gt; Participants in group: <span style="color: #0000BB;">38</span></span></span>
<span><span class="co">#&gt; Group observation period: [<span style="color: #0000BB;">0</span>, <span style="color: #0000BB;">59</span>]</span></span>
<span><span class="co">#&gt; Time to MCC = 1.0: <span style="color: #0000BB;">27</span></span></span>
<span><span class="co">#&gt; Time to maximum MCC: <span style="color: #0000BB;">47</span></span></span>
<span><span class="co">#&gt; MCC at end of follow-up: <span style="color: #0000BB;">1.6084</span></span></span>
<span><span class="co">#&gt; Events of interest: <span style="color: #0000BB;">45</span></span></span>
<span><span class="co">#&gt; Competing risk events: <span style="color: #0000BB;">11</span></span></span>
<span><span class="co">#&gt; Censoring events: <span style="color: #0000BB;">25</span></span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="visualization-of-weightedmatched-results">Visualization of Weighted/Matched Results<a class="anchor" aria-label="anchor" href="#visualization-of-weightedmatched-results"></a>
</h2>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">p_unwt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcc_unweighted</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/geom_line_mcc.html">geom_line_mcc</a></span><span class="op">(</span><span class="va">mcc_unweighted</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>, color <span class="op">=</span> <span class="st">"Treatment"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2.75</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Unweighted"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_wt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcc_weighted</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/geom_line_mcc.html">geom_line_mcc</a></span><span class="op">(</span><span class="va">mcc_weighted</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"IPTW"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Estimand: ATE"</span>, color <span class="op">=</span> <span class="st">"Treatment"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2.75</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">p_mwt</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mcc_matched</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="../reference/geom_line_mcc.html">geom_line_mcc</a></span><span class="op">(</span><span class="va">mcc_matched</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Full Matching"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span>subtitle <span class="op">=</span> <span class="st">"Estimand: ATE"</span>, color <span class="op">=</span> <span class="st">"Treatment"</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span>limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">2.75</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.title.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">combined</span> <span class="op">&lt;-</span> <span class="va">p_unwt</span> <span class="op">|</span> <span class="va">p_wt</span> <span class="op">|</span> <span class="va">p_mwt</span></span>
<span></span>
<span><span class="va">combined</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://patchwork.data-imaginist.com/reference/plot_layout.html" class="external-link">plot_layout</a></span><span class="op">(</span>guides <span class="op">=</span> <span class="st">"collect"</span><span class="op">)</span> <span class="op">&amp;</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: `label` cannot be a <span style="color: #0000BB;">&lt;ggplot2::element_blank&gt;</span> object.</span></span></code></pre></div>
<p><img src="estimating-mcc-after-matching-or-weighting_files/figure-html/plotting_comparison-1.png" width="672"></p>
</div>
<div class="section level2">
<h2 id="key-interpretation-points">Key Interpretation Points<a class="anchor" aria-label="anchor" href="#key-interpretation-points"></a>
</h2>
<div class="section level3">
<h3 id="causal-vs-descriptive-interpretation">Causal vs Descriptive Interpretation<a class="anchor" aria-label="anchor" href="#causal-vs-descriptive-interpretation"></a>
</h3>
<ul>
<li>
<strong>Unweighted MCC</strong>: Describes the observed recurrent
event burden in each treatment group</li>
<li>
<strong>Weighted/Matched MCC</strong>: Estimates the causal effect
of treatment on recurrent event burden, adjusting for (measured)
confounding</li>
</ul>
</div>
<div class="section level3">
<h3 id="assumptions">Assumptions<a class="anchor" aria-label="anchor" href="#assumptions"></a>
</h3>
<p>Weighted MCC estimation assumes the standard causal inference
assumptions:</p>
<ol style="list-style-type: decimal">
<li>
<strong>Consistency</strong>: The potential outcome under treatment
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>A</mi><mo>=</mo><mi>a</mi></mrow><annotation encoding="application/x-tex">A = a</annotation></semantics></math>
is the same as the observed outcome for those who actually received
treatment
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>a</mi><annotation encoding="application/x-tex">a</annotation></semantics></math>
</li>
<li>
<strong>Positivity</strong>: All individuals have a non-zero
probability of receiving each treatment level
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>0</mn><mo>&lt;</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>A</mi><mo>=</mo><mi>a</mi><mo stretchy="false" form="prefix">|</mo><mi>L</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>&lt;</mo><mn>1</mn></mrow><annotation encoding="application/x-tex">0 &lt; P(A = a|L) &lt; 1</annotation></semantics></math>)</li>
<li>
<strong>Conditional exchangeability (no unmeasured
confounding)</strong>: Given measured covariates <em>L</em>, treatment
assignment is independent of potential outcomes</li>
<li>
<strong>Correct model specification</strong>: The propensity score
model correctly captures the relationship between covariates and
treatment assignment</li>
</ol>
</div>
<div class="section level3">
<h3 id="stabilized-vs-unstabilized-weights">Stabilized vs Unstabilized Weights<a class="anchor" aria-label="anchor" href="#stabilized-vs-unstabilized-weights"></a>
</h3>
<p>The Gaber, <em>et al</em>. paper<a class="footnote-ref" tabindex="0" data-bs-toggle="popover" data-bs-content='&lt;p&gt;Gaber CE, Edwards JK, Lund JL, Peery AF, Richardson DB,
Kinlaw AC. Inverse Probability Weighting to Estimate Exposure Effects on
the Burden of Recurrent Outcomes in the Presence of Competing Events.
&lt;em&gt;Am J Epidemiol&lt;/em&gt;. 2023;192(5):830-839. doi: &lt;a href="https://doi.org/10.1093/aje/kwad031" class="external-link"&gt;10.1093/aje/kwad031&lt;/a&gt;&lt;/p&gt;'><sup>2</sup></a> uses stabilized weights, which have the
form:</p>
<p><math display="block" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>W</mi><mi>i</mi></msub><mo>=</mo><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>A</mi><mo>=</mo><mi>a</mi><mo stretchy="true" form="postfix">)</mo></mrow><mi>/</mi><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>A</mi><mo>=</mo><mi>a</mi><mo stretchy="false" form="prefix">|</mo><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">
W_i = P(A = a) / P(A = a | L_i) 
</annotation></semantics></math></p>
<p>Stabilized weights typically have better finite sample properties
than unstabilized weights
(<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mn>1</mn><mi>/</mi><mi>P</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>A</mi><mo>=</mo><mi>a</mi><mo stretchy="false" form="prefix">|</mo><msub><mi>L</mi><mi>i</mi></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">1 / P(A = a | L_i)</annotation></semantics></math>)
because they tend to be less extreme and more stable.</p>
</div>
</div>
<div class="section level2">
<h2 id="not-covered">Not Covered<a class="anchor" aria-label="anchor" href="#not-covered"></a>
</h2>
<p>This vignette covers how to use weights from IPTW or matching to get
an adjusted MCC point estimate. To get associated confidence intervals,
you will need to perform bootstrapping (which isn’t covered in this
vignette).</p>
</div>
<div class="section level2">
<h2 id="summary">Summary<a class="anchor" aria-label="anchor" href="#summary"></a>
</h2>
<ul>
<li>Use IPTW <em>or</em> matching weights when estimating causal effects
of treatment on recurrent event burden using observational data
<ul>
<li>Simple 1:1 nearest neighbor matching without replacement does not
require use of matching weights during analysis (because all weights are
1 [if matched] or 0 [if unmatched])</li>
<li>Complex matching methods, like full matching, optimal matching,
matching with replacement, or 1:<em>k</em> ratio (where k &gt;1),
require using the matching weights</li>
</ul>
</li>
<li>Always compare weighted/matched results to unweighted results to
assess the impact of confounding adjustment</li>
<li>Interpret weighted estimates as causal effects under standard causal
inference assumptions</li>
</ul>
</div>

  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Kenneth A. Taylor.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
