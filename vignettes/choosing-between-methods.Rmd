---
title: "Choosing Between Methods"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Choosing Between Methods}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 7,
  fig.height = 5
)
library(dplyr)
library(mccount)
```

## Quick Decision Guide

The `mccount` package offers two methods for calculating Mean Cumulative Count (MCC):

- **Equation method** (default): Direct calculation using the Dong-Yasui estimator
- **SCI method**: Sum of Cumulative Incidences estimator

**ğŸš€ TL;DR**: Use the default equation method unless you specifically need the features unique to the SCI method.

## Decision Flowchart

```
Do you need event-specific breakdowns (1st, 2nd, 3rd events)?
â”œâ”€ YES â†’ Use SCI method
â””â”€ NO
   â”œâ”€ Do you have left truncation (delayed study entry)?
   â”‚  â”œâ”€ YES â†’ Use SCI method  
   â”‚  â””â”€ NO
   â”‚     â”œâ”€ Do you need inverse probability weighting?
   â”‚     â”‚  â”œâ”€ YES â†’ Use equation method
   â”‚     â”‚  â””â”€ NO â†’ Use equation method (default)
```

## Method Comparison at a Glance

| Feature | Equation Method | SCI Method |
|---------|----------------|------------|
| **Speed** | âš¡ Fast | ğŸŒ Slower |
| **Memory usage** | ğŸ’¾ Efficient | ğŸ“š Higher |
| **Weighting support** | âœ… Yes | âŒ No |
| **Left truncation** | âŒ No | âœ… Yes |
| **Event-specific details** | âŒ No | âœ… Yes |
| **Component plots** | âŒ No | âœ… Yes |
| **Small samples** | âœ… Stable | âš ï¸ May be unstable |
| **Large datasets** | âœ… Excellent | âš ï¸ May struggle |

## When to Choose Each Method

### Use Equation Method When:

âœ… **Standard MCC analysis** - Most common use case  
âœ… **Large datasets** - Better performance and memory efficiency  
âœ… **Causal inference** - Need inverse probability weighting  
âœ… **Small samples** - More stable with limited data  
âœ… **Production environments** - Faster execution for repeated analyses  
âœ… **Events are "exchangeable"** - Order doesn't matter clinically (all hospitalizations have similar meaning)

```{r equation-example}
# Standard analysis - equation method (default)
data <- data.frame(
  id = c(1, 1, 2, 2, 3, 3, 3, 3, 4, 4, 5),
  time = c(10, 25, 15, 30, 4, 20, 30, 40, 35, 40, 40),
  cause = c(1, 0, 1, 2, 1, 1, 1, 2, 1, 0, 0)
)

mcc_eq <- mcc(data, "id", "time", "cause", method = "equation")
summary(mcc_eq)
```

### Use SCI Method When:

âœ… **Event order matters clinically** - 1st, 2nd, 3rd events have different meanings  
âœ… **Delayed study entry** - Have left truncation (`tstart_var`)  
âœ… **Diagnostic purposes** - Want to understand event composition  
âœ… **Educational/presentation** - Component plots help explain results  
âœ… **Sequential events may have different risk factors** - As in Dong et al.'s cancer example

```{r sci-example}
# When you need event-specific breakdowns
mcc_sci <- mcc(data, "id", "time", "cause", method = "sci")

# See the breakdown by event number
mcc_sci$sci_table
```

```{r sci-plot}
# Component plot shows contribution of each event order
plot(mcc_sci, type = "components", 
     title = "MCC Components: 1st, 2nd, and 3rd Events")
```

## Practical Examples

### Healthcare: Hospital Readmissions

```{r healthcare-example}
# Simulate hospital readmission data
set.seed(123)
hospital_data <- data.frame(
  patient_id = rep(1:100, each = 3)[1:250],
  days = sort(sample(1:365, 250, replace = TRUE)),
  event_type = sample(c(0, 1, 2), 250, replace = TRUE, prob = c(0.3, 0.6, 0.1)),
  hospital_type = sample(c("Academic", "Community"), 250, replace = TRUE)
)

# Remove some rows to create realistic pattern
hospital_data <- hospital_data %>%
  group_by(patient_id) %>%
  arrange(days) %>%
  slice_head(n = sample(1:4, 1)) %>%
  ungroup() %>%
  arrange(patient_id, days)

# Standard analysis: Which hospital type has higher readmission burden?
mcc_readmit <- mcc(hospital_data, "patient_id", "days", "event_type", 
                   by = "hospital_type", method = "equation")

plot(mcc_readmit, by_group = TRUE, 
     title = "Hospital Readmission Burden by Hospital Type")
```

**Interpretation**: Academic hospitals show higher average readmissions per patient over time.

### Research: Understanding Event Patterns

```{r research-example}
# When you need to understand HOW events accumulate
mcc_detailed <- mcc(hospital_data %>% filter(hospital_type == "Academic"), 
                    "patient_id", "days", "event_type", method = "sci")

# Show event composition
plot(mcc_detailed, type = "components",
     title = "Academic Hospital: Readmission Patterns",
     subtitle = "Breakdown by 1st, 2nd, 3rd+ readmissions")
```

**Research insight**: Most burden comes from first readmissions, but multiple readmissions contribute meaningfully after day 200.

## Performance Comparison

```{r performance-demo, eval=FALSE}
# Simulate larger dataset for performance testing
large_data <- data.frame(
  id = rep(1:1000, each = 5),
  time = sort(sample(1:730, 5000, replace = TRUE)),
  cause = sample(c(0, 1, 2), 5000, replace = TRUE, prob = c(0.2, 0.7, 0.1))
)

# Time both methods
system.time({
  mcc_eq_large <- mcc(large_data, "id", "time", "cause", method = "equation")
})
#   user  system elapsed 
#  0.045   0.002   0.047 

system.time({
  mcc_sci_large <- mcc(large_data, "id", "time", "cause", method = "sci")  
})
#   user  system elapsed 
#  0.234   0.008   0.243

# Equation method ~5x faster for this dataset
```

## When Methods Give Different Results

Methods should give identical results under ideal conditions, but may differ when:

### 1. Strong Dependence Between Competing Risks and Events

```{r dependent-risks}
# Simulate data where sicker patients have both more events AND higher death risk
set.seed(456)
dependent_data <- data.frame(
  id = 1:50,
  # High-risk patients (id 1-25) get more events AND more competing risks
  time_1 = c(sample(10:50, 25), sample(100:200, 25)),
  cause_1 = c(rep(1, 25), sample(c(0,1), 25, replace = TRUE)),
  time_2 = c(sample(60:100, 25), sample(250:300, 25)),
  cause_2 = c(sample(c(1,2), 25, replace = TRUE, prob = c(0.3, 0.7)),
              sample(c(0,1), 25, replace = TRUE))
) %>%
  tidyr::pivot_longer(cols = -id, 
                      names_to = c(".value", "event_num"), 
                      names_pattern = "(.+)_(.+)") %>%
  arrange(id, time) %>%
  filter(!is.na(time))

# Compare methods
mcc_eq_dep <- mcc(dependent_data, "id", "time", "cause", method = "equation")
mcc_sci_dep <- mcc(dependent_data, "id", "time", "cause", method = "sci")

# Check for differences at final timepoint
eq_final <- tail(mcc_estimates(mcc_eq_dep)$mcc, 1)
sci_final <- tail(mcc_estimates(mcc_sci_dep)$SumCIs, 1)

cat("Equation method final MCC:", round(eq_final, 3), "\n")
cat("SCI method final MCC:", round(sci_final, 3), "\n") 
cat("Difference:", round(abs(eq_final - sci_final), 3), "\n")
```

### 2. What to Do When Results Differ

When methods give different results, here's your action plan:

### 2. What to Do When Results Differ

The Dong et al. paper notes that methods are **mathematically equivalent** under ideal conditions but may differ due to censoring patterns and data characteristics. Here's how to respond:

#### Step 1: Understand Why Methods Differ

**Primary reason from Dong et al.**: Different handling of censoring events

**Equation method (MCC)**: Treats all events as "exchangeable" - when someone is censored after their 2nd event, it affects the calculation of ALL future events (whether those future events are 1st, 2nd, 3rd+ events for other people) because the at-risk denominator is reduced.

**SCI method**: Event-specific - when someone is censored after their 2nd event, it only affects the calculation of 3rd, 4th, 5th+ events for others, but NOT the calculation of 1st and 2nd events for other people.

```{r censoring-difference-example}
# Example: Patient A is censored after their 2nd hospitalization
# 
# Equation method: ALL future hospitalizations (whether 1st, 2nd, or 3rd for others) 
#                  will have higher estimates due to smaller denominator
#
# SCI method: Only affects CumI calculations for 3rd+ hospitalizations
#             CumI for 1st and 2nd hospitalizations remain unaffected
#
# This reflects the "exchangeable" vs "event-specific" philosophy
```

#### Step 2: Determine If the Difference Matters

**From Dong et al.**: Methods differ when censoring occurs in specific patterns. The choice depends on your research question:

```{r research-question-guide, eval=FALSE}
# Ask yourself: Are my events "exchangeable" or does ORDER matter?

# If events are EXCHANGEABLE (order doesn't matter clinically):
# â†’ Use equation method
# â†’ Example: "All hospitalizations represent similar healthcare burden"
# â†’ Censoring will affect all future event estimates equally

# If event ORDER matters (1st vs 2nd vs 3rd are clinically different):
# â†’ Use SCI method  
# â†’ Example: "First cancer may be different from second cancer biologically"
# â†’ Censoring will only affect estimates for higher-order events
```

#### Step 3: Apply Dong et al.'s Guidance

**Use SCI Method When:**
- **Event order matters clinically/biologically**
- **Sequential events may have different risk factors** 
- **You want event-specific cumulative incidences**

*Example from the paper*: Childhood cancer survivors, where "second cancer treatment may affect the risk of third and subsequent cancers" - they used SCI method.

**Use Equation Method When:**
- **Events are "exchangeable" (order doesn't matter biologically)**
- **You want computational efficiency**
- **Total burden is more important than event sequence**

#### Step 4: Practical Decision Making

```{r practical-decision-dong}
# Following Dong et al.'s logic:

check_if_order_matters <- function(your_research_context) {
  
  questions <- c(
    "Are 1st and 2nd events clinically/biologically equivalent?",
    "Does experiencing one event change the nature of subsequent events?", 
    "Do I need event-specific cumulative incidences?"
  )
  
  cat("Ask yourself these questions:\n")
  for(i in seq_along(questions)) {
    cat(i, ". ", questions[i], "\n")
  }
  
  cat("\nIf events are EQUIVALENT â†’ Use equation method (treats all events as exchangeable)\n")
  cat("If events are DIFFERENT â†’ Use SCI method (preserves event order distinctions)\n")
}

check_if_order_matters()
```

#### Step 5: Document Your Choice

**Following the Paper's Approach:**

```{r documentation-dong-style, eval=FALSE}
# If using SCI method (when order matters):
"We calculated MCC using the sum of cumulative incidences method 
because first, second, and subsequent events may have different 
clinical significance, making event order distinction important 
for interpretation."

# If using equation method (when events are exchangeable):
"We calculated MCC using the equation method as we were interested 
in the total burden of events, treating all occurrences as equivalent 
regardless of their sequential order within individuals."
```

#### When Both Methods Give Different Results:

**Dong et al.'s guidance**: The difference reflects how censoring affects the estimates. Choose based on your research question, not on which gives "better" results.

```{r dong-decision-tree}
# Decision tree based on Dong et al. paper
make_method_decision <- function(event_type, research_question) {
  
  # Key question from Dong et al.: Does event order matter?
  cat("Method Selection Based on Dong et al. (2015):\n")
  cat("=" %>% rep(50) %>% paste0(collapse = ""), "\n\n")
  
  cat("Primary consideration: Does the ORDER of events matter for your research?\n\n")
  
  cat("Use SCI METHOD if:\n")
  cat("- 1st, 2nd, 3rd events have different clinical significance\n")
  cat("- Previous events change the risk of future events\n") 
  cat("- You need event-specific cumulative incidences\n")
  cat("- You want to distinguish event patterns\n\n")
  
  cat("Use EQUATION METHOD if:\n")
  cat("- Events are 'exchangeable' (order doesn't matter)\n")
  cat("- You want total burden regardless of sequence\n")
  cat("- You need computational efficiency\n")
  cat("- Standard MCC interpretation is sufficient\n\n")
  
  cat("NOTE: Both methods are mathematically equivalent under ideal conditions.\n")
  cat("Differences arise from censoring patterns, not method superiority.\n")
}

make_method_decision()
```

#### Real Example Using Paper's Logic:

```{r real-example-dong-logic}
# Hospital readmissions: Are repeat admissions "exchangeable"?

# Option 1 - Events are exchangeable:
# All readmissions represent similar healthcare burden/quality issues
# â†’ Use equation method

# Option 2 - Event order matters:  
# - 1st readmission: May indicate discharge too early
# - 2nd readmission: May indicate chronic condition  
# - 3rd+ readmissions: May indicate complex comorbidities
# â†’ Use SCI method

# For our hospital example, let's assume events are exchangeable:
hospital_decision <- "equation"

cat("Hospital readmission decision:", hospital_decision, "\n")
cat("Reasoning: We're treating all readmissions as equivalent indicators")
cat(" of healthcare burden, regardless of whether they are the 1st, 2nd, or 3rd")
cat(" readmission for each patient.\n")
```

#### Summary of Dong et al.'s Guidance:

1. **Both methods are mathematically equivalent** under ideal conditions
2. **Differences arise from censoring patterns**, not method flaws
3. **Choose based on research question**: Does event order matter?
4. **SCI method**: When events are not exchangeable (order/sequence matters)
5. **Equation method**: When events are exchangeable (order doesn't matter)  
6. **Document your reasoning** based on the clinical/biological significance of event order

The key insight from Dong et al. is that method choice should be **driven by your research question** rather than by which method gives different (or "better") numerical results.

## Advanced: Left Truncation Example

The SCI method's unique ability to handle left truncation (delayed study entry):

```{r left-truncation}
# Electronic health records: patients enter study at different times
ehr_data <- data.frame(
  patient_id = rep(1:30, each = 2),
  study_entry = rep(sample(0:100, 30, replace = TRUE), each = 2),  # Delayed entry
  time = rep(sample(0:100, 30, replace = TRUE), each = 2) + 
         rep(sample(50:200, 30, replace = TRUE), each = 2),        # Event times after entry
  event_type = sample(c(0, 1, 2), 60, replace = TRUE, prob = c(0.3, 0.6, 0.1))
) %>%
  filter(time > study_entry) %>%  # Events must occur after study entry
  arrange(patient_id, time)

# Only SCI method can handle delayed entry
mcc_truncated <- mcc(ehr_data, "patient_id", "time", "event_type", 
                     tstart_var = "study_entry", method = "sci")

plot(mcc_truncated, 
     title = "MCC with Delayed Study Entry",
     subtitle = "Accounts for patients entering study at different times")
```

## Recommendations by Use Case

### Clinical Trials
- **Standard efficacy analysis**: Equation method
- **Safety monitoring with event details**: SCI method  
- **Causal inference with confounding**: Equation method with weights

### Healthcare Operations  
- **Resource planning**: Equation method (faster for large datasets)
- **Quality improvement (understanding patterns)**: SCI method
- **Cost analysis**: Either method, choose based on other needs

### Epidemiological Studies
- **Descriptive burden assessment**: Equation method
- **Causal analysis of interventions**: Equation method with weights
- **Life course research with delayed entry**: SCI method

## Summary

**Default recommendation**: Use the equation method unless you specifically need:
- Event-specific breakdowns â†’ SCI method
- Left truncation support â†’ SCI method  
- Component visualization â†’ SCI method

**Key principle**: Both methods are mathematically equivalent under ideal conditions. Choose based on your specific analytical needs, computational constraints, and output requirements.

**When in doubt**: Start with equation method. You can always re-run with SCI method if you need its specialized features.

For theoretical background on why these methods are equivalent, see Dong et al. (2015) doi:10.1093/aje/kwu289.
